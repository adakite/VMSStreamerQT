name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact: VMSstreamerQt-macos.zip
          - os: windows-latest
            artifact: VMSstreamerQt-windows.zip
          - os: ubuntu-20.04
            artifact: VMSstreamerQt-linux.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.3'
          modules: 'qtcharts'

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install curl openssl@3

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev

      - name: Install vcpkg deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:GITHUB_WORKSPACE\vcpkg
          & $env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat
          & $env:GITHUB_WORKSPACE\vcpkg\vcpkg.exe install curl openssl --triplet x64-windows

      - name: Configure
        shell: bash
        run: |
          EXTRA_ARGS=""
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            EXTRA_ARGS="-DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake"
          fi
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${QT_ROOT_DIR} ${EXTRA_ARGS}

      - name: Build
        run: cmake --build build --config Release

      - name: Install
        run: cmake --install build --config Release --prefix install

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          ditto -c -k --sequesterRsrc --keepParent install/VMSstreamerQt.app ${{ matrix.artifact }}

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path install/* -DestinationPath ${{ matrix.artifact }}

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          tar -czf ${{ matrix.artifact }} -C install .

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.artifact }}
