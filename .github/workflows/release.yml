name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact: VMSstreamerQt-macos.dmg
          - os: windows-latest
            artifact: VMSstreamerQt-windows.msi
          - os: ubuntu-20.04
            artifact: VMSstreamerQt-linux.AppImage

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.3'
          modules: 'qtcharts'

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install curl openssl@3

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libfuse2

      - name: Install vcpkg deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:GITHUB_WORKSPACE\vcpkg
          & $env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat
          & $env:GITHUB_WORKSPACE\vcpkg\vcpkg.exe install curl openssl --triplet x64-windows

      - name: Configure
        shell: bash
        run: |
          EXTRA_ARGS=""
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            EXTRA_ARGS="-DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake"
          fi
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${QT_ROOT_DIR} ${EXTRA_ARGS}

      - name: Build
        run: cmake --build build --config Release

      - name: Install
        run: cmake --install build --config Release --prefix install

      - name: Package (macOS DMG)
        if: runner.os == 'macOS'
        run: |
          hdiutil create -volname VMSstreamerQt -srcfolder install/VMSstreamerQt.app -ov -format UDZO ${{ matrix.artifact }}

      - name: Package (Windows MSI)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cpack --config build/CPackConfig.cmake -B package -G WIX
          $msi = Get-ChildItem package -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw \"MSI not found\" }
          Copy-Item $msi.FullName ${{ matrix.artifact }}

      - name: Package (Linux AppImage)
        if: runner.os == 'Linux'
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage -O linuxdeploy.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage -O linuxdeploy-plugin-qt.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-qt.AppImage
          cmake --install build --config Release --prefix AppDir/usr
          export QTDIR="${QT_ROOT_DIR}"
          export PATH="${QT_ROOT_DIR}/bin:${PATH}"
          ./linuxdeploy.AppImage --appdir AppDir \
            --desktop-file packaging/VMSstreamerQt.desktop \
            --icon-file resources/vmsstreamer.png \
            --plugin qt \
            --output appimage
          APPIMAGE=$(ls *.AppImage | head -n 1)
          mv "$APPIMAGE" "${{ matrix.artifact }}"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.artifact }}
