name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact: VMSstreamerQt-macos.dmg
          - os: windows-latest
            artifact: VMSstreamerQt-windows.msi
          - os: ubuntu-20.04
            artifact: VMSstreamerQt-linux.AppImage

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.3'
          modules: 'qtcharts'

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install curl openssl@3

      - name: Import signing certificate (macOS)
        if: runner.os == 'macOS' && secrets.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libfuse2

      - name: Install vcpkg deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:GITHUB_WORKSPACE\vcpkg
          & $env:GITHUB_WORKSPACE\vcpkg\bootstrap-vcpkg.bat
          & $env:GITHUB_WORKSPACE\vcpkg\vcpkg.exe install curl openssl --triplet x64-windows

      - name: Configure
        shell: bash
        run: |
          EXTRA_ARGS=""
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            EXTRA_ARGS="-DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake"
          fi
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${QT_ROOT_DIR} ${EXTRA_ARGS}

      - name: Build
        run: cmake --build build --config Release

      - name: Install
        run: cmake --install build --config Release --prefix install

      - name: Codesign app (macOS)
        if: runner.os == 'macOS' && secrets.MACOS_CERTIFICATE != ''
        env:
          MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
        run: |
          codesign --force --deep --options runtime --timestamp --sign "$MACOS_SIGN_IDENTITY" install/VMSstreamerQt.app
          codesign --verify --deep --strict install/VMSstreamerQt.app

      - name: Package (macOS DMG)
        if: runner.os == 'macOS'
        run: |
          hdiutil create -volname VMSstreamerQt -srcfolder install/VMSstreamerQt.app -ov -format UDZO ${{ matrix.artifact }}

      - name: Notarize DMG (macOS)
        if: runner.os == 'macOS' && secrets.APPLE_ID != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          xcrun notarytool submit ${{ matrix.artifact }} --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_APP_PASSWORD" --wait
          xcrun stapler staple ${{ matrix.artifact }}

      - name: Package (Windows MSI)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cpack --config build/CPackConfig.cmake -B package -G WIX
          $msi = Get-ChildItem package -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw \"MSI not found\" }
          Copy-Item $msi.FullName ${{ matrix.artifact }}

      - name: Package (Linux AppImage)
        if: runner.os == 'Linux'
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage -O linuxdeploy.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage -O linuxdeploy-plugin-qt.AppImage
          chmod +x linuxdeploy.AppImage linuxdeploy-plugin-qt.AppImage
          cmake --install build --config Release --prefix AppDir/usr
          export QTDIR="${QT_ROOT_DIR}"
          export PATH="${QT_ROOT_DIR}/bin:${PATH}"
          ./linuxdeploy.AppImage --appdir AppDir \
            --desktop-file packaging/VMSstreamerQt.desktop \
            --icon-file resources/vmsstreamer.png \
            --plugin qt \
            --output appimage
          APPIMAGE=$(ls *.AppImage | head -n 1)
          mv "$APPIMAGE" "${{ matrix.artifact }}"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.artifact }}
